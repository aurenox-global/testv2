<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Tracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 16px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease;
        }

        .status-card:hover {
            transform: translateY(-2px);
        }

        .status-card .number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .status-card .label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 8px 0;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 2px solid #667eea;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
        }

        .btn.success {
            background: linear-gradient(135deg, #00d2d3, #54a0ff);
            box-shadow: 0 4px 16px rgba(0, 210, 211, 0.3);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffa726, #ff6f00);
            box-shadow: 0 4px 16px rgba(255, 167, 38, 0.3);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .delivery-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .delivery-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .delivery-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .delivery-item.completed {
            border-left-color: #00d2d3;
            opacity: 0.8;
        }

        .delivery-item.in-progress {
            border-left-color: #ffa726;
            background: linear-gradient(135deg, rgba(255, 167, 38, 0.1), rgba(255, 193, 7, 0.1));
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .client-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .delivery-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(255, 167, 38, 0.2);
            color: #f57c00;
        }

        .status-in-progress {
            background: rgba(33, 150, 243, 0.2);
            color: #1976d2;
        }

        .status-completed {
            background: rgba(76, 175, 80, 0.2);
            color: #388e3c;
        }

        .delivery-details {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 8px;
            flex: 1;
        }

        .shift-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .shift-time {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .time-display {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modal h3 {
            text-align: center;
            margin-bottom: 24px;
            color: #333;
            font-size: 20px;
            font-weight: 700;
        }

        .distance-display {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin: 16px 0;
        }

        .working-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .not-working-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #f44336;
            border-radius: 50%;
            margin-left: 8px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
        }

        .history-date {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .nav-arrows {
            display: flex;
            gap: 8px;
        }

        .arrow-btn {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .arrow-btn:hover {
            background: #667eea;
            color: white;
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .day-cell:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .day-cell.has-data {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
        }

        .day-cell .day-number {
            font-size: 16px;
            color: #333;
        }

        .day-cell .delivery-count {
            font-size: 11px;
            color: #667eea;
            margin-top: 2px;
        }

        .delete-options {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            border: 2px solid rgba(255, 107, 107, 0.3);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .status-cards {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            max-width: 320px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ Delivery Tracker Pro</h1>
            <div class="stats-grid">
                <div class="status-card">
                    <div class="number" id="totalPackages">0</div>
                    <div class="label">Paquetes</div>
                </div>
                <div class="status-card">
                    <div class="number" id="deliveredPackages">0</div>
                    <div class="label">Entregados</div>
                </div>
                <div class="status-card">
                    <div class="number" id="totalDistance">0</div>
                    <div class="label">km</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('today')">Hoy</button>
            <button class="nav-tab" onclick="switchTab('history')">Historial</button>
            <button class="nav-tab" onclick="switchTab('settings')">Ajustes</button>
        </div>

        <!-- Tab Content: Today -->
        <div id="todayTab" class="tab-content active">
            <!-- Shift Info -->
            <div class="shift-info">
                <div class="shift-time">
                    <span>Estado:</span>
                    <span class="time-display" id="shiftStatus">
                        Sin iniciar
                        <span class="not-working-indicator" id="statusIndicator"></span>
                    </span>
                </div>
                <div class="shift-time">
                    <span>Inicio:</span>
                    <span class="time-display" id="startTime">--:--</span>
                </div>
                <div class="shift-time">
                    <span>Fin:</span>
                    <span class="time-display" id="endTime">--:--</span>
                </div>
                <button class="btn" id="shiftBtn" onclick="toggleShift()">Iniciar Jornada</button>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="input-group">
                    <label for="clientName">Nombre del Cliente</label>
                    <input type="text" id="clientName" placeholder="Ej: Juan P√©rez">
                </div>
                <button class="btn success" onclick="startDelivery()">Iniciar Entrega</button>
            </div>

            <!-- Delivery List -->
            <div class="delivery-list">
                <h3 style="margin-bottom: 16px; color: #333; font-weight: 600;">Entregas de Hoy</h3>
                <div id="deliveryList">
                    <p style="text-align: center; color: #999; font-style: italic;">No hay entregas registradas</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group">
                <button class="btn secondary" onclick="generatePDF()" id="exportBtn" disabled>
                    üìÑ Generar PDF
                </button>
                <button class="btn warning" onclick="showNewDayModal()">
                    üîÑ D√≠a Nuevo
                </button>
            </div>
        </div>

        <!-- Tab Content: History -->
        <div id="historyTab" class="tab-content">
            <div class="history-section">
                <div class="history-navigation">
                    <button class="arrow-btn" onclick="changeHistoryView(-1)">‚óÄ</button>
                    <div class="history-date" id="historyDate">Noviembre 2024</div>
                    <button class="arrow-btn" onclick="changeHistoryView(1)">‚ñ∂</button>
                </div>
                
                <div class="calendar-view" id="calendarView">
                    <!-- Calendar will be generated here -->
                </div>
                
                <div id="historyDeliveries" class="delivery-list">
                    <p style="text-align: center; color: #999; font-style: italic;">Selecciona un d√≠a para ver las entregas</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Settings -->
        <div id="settingsTab" class="tab-content">
            <div class="controls">
                <h3 style="margin-bottom: 20px; color: #333; font-weight: 600;">Gesti√≥n de Datos</h3>
                
                <!-- Export/Import Section -->
                <div style="margin-bottom: 24px;">
                    <button class="btn" onclick="exportData()">
                        üíæ Exportar Datos
                    </button>
                    
                    <div class="file-input-wrapper" style="margin-top: 12px;">
                        <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                        <label for="importFile" class="file-input-label">
                            üìÇ Importar Datos
                        </label>
                    </div>
                </div>

                <!-- Delete Options -->
                <div class="delete-options">
                    <h4 style="color: #ff6b6b; margin-bottom: 16px; font-weight: 600;">‚ö†Ô∏è Zona de Eliminaci√≥n</h4>
                    
                    <button class="btn danger" onclick="showDeleteModal('day')">
                        üóìÔ∏è Borrar D√≠a
                    </button>
                    
                    <button class="btn danger" onclick="showDeleteModal('month')">
                        üìÖ Borrar Mes
                    </button>
                    
                    <button class="btn danger" onclick="showDeleteModal('year')">
                        üìÜ Borrar A√±o
                    </button>
                    
                    <button class="btn danger" onclick="showDeleteModal('all')">
                        üóëÔ∏è Borrar Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for delivery completion -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <h3>Completar Entrega</h3>
            <p style="text-align: center; margin-bottom: 16px;">Cliente: <span id="modalClientName"></span></p>
            <div class="distance-display" id="modalDistance">0 km</div>
            <p style="text-align: center; color: #666; margin-bottom: 24px;">Distancia recorrida</p>
            <button class="btn success" onclick="completeDelivery()">Entrega Completada</button>
            <button class="btn secondary" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal for new day -->
    <div class="modal" id="newDayModal">
        <div class="modal-content">
            <h3>üîÑ Iniciar D√≠a Nuevo</h3>
            <p style="text-align: center; color: #666; margin-bottom: 24px;">
                Esto guardar√° las entregas de hoy en el historial y reiniciar√° la aplicaci√≥n para un nuevo d√≠a de trabajo.
            </p>
            <button class="btn success" onclick="startNewDay()">Iniciar D√≠a Nuevo</button>
            <button class="btn secondary" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal for password -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3 id="passwordModalTitle">Ingrese Contrase√±a</h3>
            <div class="input-group">
                <label for="passwordInput">Contrase√±a</label>
                <input type="password" id="passwordInput" placeholder="Ingrese su contrase√±a">
            </div>
            <button class="btn" id="passwordConfirmBtn">Confirmar</button>
            <button class="btn secondary" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal for delete confirmation -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
            <p id="deleteMessage" style="text-align: center; color: #666; margin-bottom: 24px;"></p>
            <div class="input-group">
                <label for="deleteDate">Selecciona fecha:</label>
                <input type="date" id="deleteDate">
            </div>
            <button class="btn danger" id="confirmDeleteBtn">Eliminar</button>
            <button class="btn secondary" onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let isShiftActive = false;
        let shiftStartTime = null;
        let shiftEndTime = null;
        let deliveries = [];
        let currentDelivery = null;
        let lastPosition = null;
        let totalDistance = 0;
        let watchId = null;
        let historyData = {};
        let currentHistoryDate = new Date();
        let deleteType = '';

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadHistoryData();
            loadTodayData();
            updateStats();
            updateDeliveryList();
            updateCalendarView();
            
            // Solicitar permisos de geolocalizaci√≥n
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    () => showNotification('GPS listo para usar', 'success'),
                    () => showNotification('GPS no disponible. Funcionalidad limitada.', 'warning')
                );
            }
        });

        // Funciones de navegaci√≥n
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'history') {
                updateCalendarView();
            }
        }

        // Funciones de almacenamiento
        function saveToLocalStorage() {
            const todayKey = getTodayKey();
            if (!historyData[todayKey]) {
                historyData[todayKey] = {
                    deliveries: [],
                    shiftStartTime: null,
                    shiftEndTime: null,
                    totalDistance: 0
                };
            }
            
            historyData[todayKey] = {
                deliveries: deliveries,
                shiftStartTime: shiftStartTime,
                shiftEndTime: shiftEndTime,
                totalDistance: totalDistance
            };
            
            localStorage.setItem('deliveryHistory', JSON.stringify(historyData));
        }

        function loadHistoryData() {
            const saved = localStorage.getItem('deliveryHistory');
            if (saved) {
                historyData = JSON.parse(saved);
            }
        }

        function loadTodayData() {
            const todayKey = getTodayKey();
            if (historyData[todayKey]) {
                const todayData = historyData[todayKey];
                deliveries = todayData.deliveries || [];
                shiftStartTime = todayData.shiftStartTime ? new Date(todayData.shiftStartTime) : null;
                shiftEndTime = todayData.shiftEndTime ? new Date(todayData.shiftEndTime) : null;
                totalDistance = todayData.totalDistance || 0;
                
                if (shiftStartTime && !shiftEndTime) {
                    isShiftActive = true;
                    document.getElementById('shiftBtn').textContent = 'Finalizar Jornada';
                    document.getElementById('shiftBtn').className = 'btn danger';
                }
                
                updateShiftDisplay();
            }
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;
        }

        // Funci√≥n para obtener la ubicaci√≥n actual
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalizaci√≥n no soportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        // Funci√≥n para calcular distancia entre dos puntos
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Funci√≥n para formatear tiempo
        function formatTime(date) {
            return date.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Funci√≥n para formatear duraci√≥n
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours > 0) {
                return `${hours}h ${mins}m`;
            }
            return `${mins}m`;
        }

        // Iniciar/Finalizar jornada
        function toggleShift() {
            if (!isShiftActive) {
                startShift();
            } else {
                endShift();
            }
        }

        async function startShift() {
            try {
                const position = await getCurrentPosition();
                isShiftActive = true;
                shiftStartTime = new Date();
                lastPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                if (navigator.geolocation) {
                    watchId = navigator.geolocation.watchPosition(
                        updatePosition,
                        (error) => console.warn('Error tracking position:', error),
                        { enableHighAccuracy: true, maximumAge: 30000, timeout: 15000 }
                    );
                }

                updateShiftDisplay();
                document.getElementById('shiftBtn').textContent = 'Finalizar Jornada';
                document.getElementById('shiftBtn').className = 'btn danger';
                
                saveToLocalStorage();
                showNotification('¬°Jornada iniciada! GPS activado', 'success');
            } catch (error) {
                showNotification('Error al acceder a GPS. Funcionalidad limitada.', 'warning');
                isShiftActive = true;
                shiftStartTime = new Date();
                updateShiftDisplay();
                document.getElementById('shiftBtn').textContent = 'Finalizar Jornada';
                document.getElementById('shiftBtn').className = 'btn danger';
                saveToLocalStorage();
            }
        }

        function endShift() {
            isShiftActive = false;
            shiftEndTime = new Date();
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            updateShiftDisplay();
            document.getElementById('shiftBtn').textContent = 'Iniciar Jornada';
            document.getElementById('shiftBtn').className = 'btn';
            document.getElementById('exportBtn').disabled = false;
            
            saveToLocalStorage();
            showNotification('Jornada finalizada. Puedes generar el reporte.', 'info');
        }

        function updateShiftDisplay() {
            const statusEl = document.getElementById('shiftStatus');
            const indicatorEl = document.getElementById('statusIndicator');
            const startTimeEl = document.getElementById('startTime');
            const endTimeEl = document.getElementById('endTime');

            if (isShiftActive) {
                statusEl.innerHTML = 'Trabajando <span class="working-indicator"></span>';
                startTimeEl.textContent = formatTime(shiftStartTime);
                endTimeEl.textContent = '--:--';
            } else if (shiftStartTime) {
                statusEl.innerHTML = 'Finalizada <span class="not-working-indicator"></span>';
                startTimeEl.textContent = formatTime(shiftStartTime);
                endTimeEl.textContent = shiftEndTime ? formatTime(shiftEndTime) : '--:--';
            }
        }

        // Actualizar posici√≥n
        function updatePosition(position) {
            if (currentDelivery && lastPosition) {
                const newPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                const distance = calculateDistance(
                    lastPosition.lat, lastPosition.lng,
                    newPosition.lat, newPosition.lng
                );

                if (distance > 0.01) {
                    currentDelivery.distance += distance;
                    totalDistance += distance;
                    lastPosition = newPosition;
                    updateStats();
                    saveToLocalStorage();
                }
            }
        }

        // Iniciar entrega
        async function startDelivery() {
            const clientName = document.getElementById('clientName').value.trim();
            
            if (!isShiftActive) {
                showNotification('Debes iniciar la jornada primero', 'error');
                return;
            }

            if (!clientName) {
                showNotification('Ingresa el nombre del cliente', 'error');
                return;
            }

            if (currentDelivery) {
                showNotification('Ya tienes una entrega en progreso', 'error');
                return;
            }

            try {
                const position = await getCurrentPosition();
                
                currentDelivery = {
                    id: Date.now(),
                    client: clientName,
                    startTime: new Date(),
                    endTime: null,
                    distance: 0,
                    status: 'in-progress',
                    startPosition: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    }
                };

                lastPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                deliveries.push(currentDelivery);
                document.getElementById('clientName').value = '';
                updateDeliveryList();
                updateStats();
                saveToLocalStorage();
                
                showNotification(`Entrega iniciada para ${clientName}`, 'success');
            } catch (error) {
                currentDelivery = {
                    id: Date.now(),
                    client: clientName,
                    startTime: new Date(),
                    endTime: null,
                    distance: 0,
                    status: 'in-progress'
                };

                deliveries.push(currentDelivery);
                document.getElementById('clientName').value = '';
                updateDeliveryList();
                updateStats();
                saveToLocalStorage();
                
                showNotification(`Entrega iniciada para ${clientName} (sin GPS)`, 'warning');
            }
        }

        // Completar entrega
        function openCompleteModal(deliveryId) {
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            document.getElementById('modalClientName').textContent = delivery.client;
            document.getElementById('modalDistance').textContent = `${delivery.distance.toFixed(2)} km`;
            document.getElementById('completeModal').style.display = 'block';
            document.getElementById('completeModal').dataset.deliveryId = deliveryId;
        }

        function completeDelivery() {
            const deliveryId = parseInt(document.getElementById('completeModal').dataset.deliveryId);
            const delivery = deliveries.find(d => d.id === deliveryId);
            
            if (delivery) {
                delivery.endTime = new Date();
                delivery.status = 'completed';
                
                if (currentDelivery && currentDelivery.id === deliveryId) {
                    currentDelivery = null;
                }
                
                updateDeliveryList();
                updateStats();
                saveToLocalStorage();
                closeModal();
                
                showNotification(`Entrega completada para ${delivery.client}`, 'success');
            }
        }

        // Actualizar lista de entregas
        function updateDeliveryList() {
            const listEl = document.getElementById('deliveryList');
            
            if (deliveries.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No hay entregas registradas</p>';
                return;
            }

            listEl.innerHTML = deliveries.map(delivery => {
                const duration = delivery.endTime ? 
                    Math.round((delivery.endTime - delivery.startTime) / (1000 * 60)) : 
                    Math.round((new Date() - delivery.startTime) / (1000 * 60));

                let statusClass = 'status-pending';
                let statusText = 'Pendiente';
                
                if (delivery.status === 'in-progress') {
                    statusClass = 'status-in-progress';
                    statusText = 'En Progreso';
                } else if (delivery.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = 'Completada';
                }

                return `
                    <div class="delivery-item ${delivery.status}">
                        <div class="delivery-header">
                            <div class="client-name">${delivery.client}</div>
                            <div class="delivery-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="delivery-details">
                            <div>üïê Inicio: ${formatTime(delivery.startTime)}</div>
                            <div>üìç Distancia: ${delivery.distance.toFixed(2)} km</div>
                            <div>‚è±Ô∏è Duraci√≥n: ${formatDuration(duration)}</div>
                            ${delivery.endTime ? `<div>‚úÖ Finalizada: ${formatTime(delivery.endTime)}</div>` : ''}
                        </div>
                        ${delivery.status === 'in-progress' ? `
                            <div class="action-buttons">
                                <button class="btn btn-small success" onclick="openCompleteModal(${delivery.id})">
                                    ‚úÖ Completar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const completed = deliveries.filter(d => d.status === 'completed').length;
            
            document.getElementById('totalPackages').textContent = deliveries.length;
            document.getElementById('deliveredPackages').textContent = completed;
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(1);
        }

        // Historial
        function updateCalendarView() {
            const year = currentHistoryDate.getFullYear();
            const month = currentHistoryDate.getMonth();
            
            document.getElementById('historyDate').textContent = 
                currentHistoryDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHTML = '';
            const weekDays = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            // Headers
            weekDays.forEach(day => {
                calendarHTML += `<div style="text-align: center; font-size: 12px; color: #666; padding: 8px;">${day}</div>`;
            });
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div></div>';
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${(month+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
                const hasData = historyData[dateKey] && historyData[dateKey].deliveries && historyData[dateKey].deliveries.length > 0;
                const deliveryCount = hasData ? historyData[dateKey].deliveries.length : 0;
                
                calendarHTML += `
                    <div class="day-cell ${hasData ? 'has-data' : ''}" onclick="showDayHistory('${dateKey}')">
                        <div class="day-number">${day}</div>
                        ${hasData ? `<div class="delivery-count">${deliveryCount} üì¶</div>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('calendarView').innerHTML = calendarHTML;
        }

        function changeHistoryView(direction) {
            currentHistoryDate.setMonth(currentHistoryDate.getMonth() + direction);
            updateCalendarView();
        }

        function showDayHistory(dateKey) {
            const dayData = historyData[dateKey];
            const historyDeliveriesEl = document.getElementById('historyDeliveries');
            
            if (!dayData || !dayData.deliveries || dayData.deliveries.length === 0) {
                historyDeliveriesEl.innerHTML = '<p style="text-align: center; color: #999; font-style: italic;">No hay entregas en esta fecha</p>';
                return;
            }
            
            const date = new Date(dateKey);
            const dateStr = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let html = `<h4 style="margin-bottom: 16px; color: #667eea;">${dateStr}</h4>`;
            
            // Stats
            const totalDeliveries = dayData.deliveries.length;
            const completedDeliveries = dayData.deliveries.filter(d => d.status === 'completed').length;
            const totalDist = dayData.totalDistance || 0;
            
            html += `
                <div class="stats-grid" style="margin-bottom: 16px;">
                    <div class="status-card">
                        <div class="number">${totalDeliveries}</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="status-card">
                        <div class="number">${completedDeliveries}</div>
                        <div class="label">Completadas</div>
                    </div>
                    <div class="status-card">
                        <div class="number">${totalDist.toFixed(1)}</div>
                        <div class="label">km</div>
                    </div>
                </div>
            `;
            
            // Deliveries
            dayData.deliveries.forEach(delivery => {
                const startTime = new Date(delivery.startTime);
                const endTime = delivery.endTime ? new Date(delivery.endTime) : null;
                const duration = endTime ? 
                    Math.round((endTime - startTime) / (1000 * 60)) : 0;
                
                html += `
                    <div class="delivery-item ${delivery.status}">
                        <div class="delivery-header">
                            <div class="client-name">${delivery.client}</div>
                            <div class="delivery-status status-${delivery.status}">${
                                delivery.status === 'completed' ? 'Completada' : 'No completada'
                            }</div>
                        </div>
                        <div class="delivery-details">
                            <div>üïê ${formatTime(startTime)} - ${endTime ? formatTime(endTime) : 'N/A'}</div>
                            <div>üìç ${delivery.distance.toFixed(2)} km</div>
                            ${duration ? `<div>‚è±Ô∏è ${formatDuration(duration)}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            historyDeliveriesEl.innerHTML = html;
        }

        // Funciones de gesti√≥n
        function showNewDayModal() {
            document.getElementById('newDayModal').style.display = 'block';
        }

        function startNewDay() {
            if (deliveries.length > 0) {
                saveToLocalStorage();
            }
            
            // Reset variables
            isShiftActive = false;
            shiftStartTime = null;
            shiftEndTime = null;
            deliveries = [];
            currentDelivery = null;
            totalDistance = 0;
            
            // Update UI
            document.getElementById('shiftBtn').textContent = 'Iniciar Jornada';
            document.getElementById('shiftBtn').className = 'btn';
            document.getElementById('exportBtn').disabled = true;
            updateShiftDisplay();
            updateStats();
            updateDeliveryList();
            
            closeModal();
            showNotification('¬°Nuevo d√≠a iniciado!', 'success');
        }

        // Export/Import
        function exportData() {
            showPasswordModal('export');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showPasswordModal('import', file);
        }

        function showPasswordModal(action, file = null) {
            const modal = document.getElementById('passwordModal');
            const title = document.getElementById('passwordModalTitle');
            const btn = document.getElementById('passwordConfirmBtn');
            
            title.textContent = action === 'export' ? 'Crear contrase√±a para exportar' : 'Ingrese contrase√±a del archivo';
            
            btn.onclick = () => {
                const password = document.getElementById('passwordInput').value;
                if (!password) {
                    showNotification('Por favor ingrese una contrase√±a', 'error');
                    return;
                }
                
                if (action === 'export') {
                    performExport(password);
                } else {
                    performImport(file, password);
                }
                
                document.getElementById('passwordInput').value = '';
                closeModal();
            };
            
            modal.style.display = 'block';
        }

        function performExport(password) {
            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: historyData,
                encrypted: btoa(password) // Simple encoding for demo
            };
            
            const json = JSON.stringify(dataToExport);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `delivery_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('Datos exportados exitosamente', 'success');
        }

        function performImport(file, password) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Verify password (simple check for demo)
                    if (imported.encrypted !== btoa(password)) {
                        showNotification('Contrase√±a incorrecta', 'error');
                        return;
                    }
                    
                    // Merge or replace data
                    if (confirm('¬øDeseas reemplazar todos los datos actuales?')) {
                        historyData = imported.data;
                    } else {
                        // Merge data
                        Object.keys(imported.data).forEach(key => {
                            if (!historyData[key]) {
                                historyData[key] = imported.data[key];
                            }
                        });
                    }
                    
                    localStorage.setItem('deliveryHistory', JSON.stringify(historyData));
                    loadTodayData();
                    updateStats();
                    updateDeliveryList();
                    updateCalendarView();
                    
                    showNotification('Datos importados exitosamente', 'success');
                } catch (error) {
                    showNotification('Error al importar archivo', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Delete functions
        function showDeleteModal(type) {
            deleteType = type;
            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('deleteMessage');
            const dateInput = document.getElementById('deleteDate');
            const btn = document.getElementById('confirmDeleteBtn');
            
            let messageText = '';
            dateInput.style.display = 'block';
            
            switch(type) {
                case 'day':
                    messageText = 'Selecciona el d√≠a a eliminar';
                    dateInput.type = 'date';
                    break;
                case 'month':
                    messageText = 'Selecciona un d√≠a del mes a eliminar';
                    dateInput.type = 'date';
                    break;
                case 'year':
                    messageText = 'Selecciona un d√≠a del a√±o a eliminar';
                    dateInput.type = 'date';
                    break;
                case 'all':
                    messageText = '¬øEst√°s seguro de eliminar TODOS los datos?';
                    dateInput.style.display = 'none';
                    break;
            }
            
            message.textContent = messageText;
            
            btn.onclick = () => performDelete();
            
            modal.style.display = 'block';
        }

        function performDelete() {
            const dateInput = document.getElementById('deleteDate').value;
            
            switch(deleteType) {
                case 'day':
                    if (!dateInput) {
                        showNotification('Selecciona una fecha', 'error');
                        return;
                    }
                    delete historyData[dateInput];
                    break;
                    
                case 'month':
                    if (!dateInput) {
                        showNotification('Selecciona una fecha', 'error');
                        return;
                    }
                    const [year, month] = dateInput.split('-');
                    Object.keys(historyData).forEach(key => {
                        if (key.startsWith(`${year}-${month}`)) {
                            delete historyData[key];
                        }
                    });
                    break;
                    
                case 'year':
                    if (!dateInput) {
                        showNotification('Selecciona una fecha', 'error');
                        return;
                    }
                    const yearToDelete = dateInput.split('-')[0];
                    Object.keys(historyData).forEach(key => {
                        if (key.startsWith(yearToDelete)) {
                            delete historyData[key];
                        }
                    });
                    break;
                    
                case 'all':
                    if (confirm('¬øREALMENTE deseas eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                        historyData = {};
                        deliveries = [];
                        shiftStartTime = null;
                        shiftEndTime = null;
                        totalDistance = 0;
                        isShiftActive = false;
                        currentDelivery = null;
                    }
                    break;
            }
            
            localStorage.setItem('deliveryHistory', JSON.stringify(historyData));
            updateCalendarView();
            showNotification('Datos eliminados exitosamente', 'success');
            closeModal();
            
            // Reload today data if it was affected
            if (deleteType === 'all' || (dateInput && dateInput === getTodayKey())) {
                location.reload();
            }
        }

        // Modal functions
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.borderLeft = `4px solid ${
                type === 'success' ? '#4caf50' : 
                type === 'error' ? '#f44336' : 
                type === 'warning' ? '#ff9800' : '#2196f3'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Generate PDF
        function generatePDF() {
            if (deliveries.length === 0) {
                showNotification('No hay entregas para exportar', 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Reporte de Entregas', 20, 20);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            let yPos = 40;

            if (shiftStartTime) {
                doc.text(`Inicio de jornada: ${shiftStartTime.toLocaleString('es-ES')}`, 20, yPos);
                yPos += 8;
            }

            if (shiftEndTime) {
                doc.text(`Fin de jornada: ${shiftEndTime.toLocaleString('es-ES')}`, 20, yPos);
                yPos += 8;
            }

            if (shiftStartTime && shiftEndTime) {
                const duration = Math.round((shiftEndTime - shiftStartTime) / (1000 * 60));
                doc.text(`Duraci√≥n total: ${formatDuration(duration)}`, 20, yPos);
                yPos += 8;
            }

            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(102, 126, 234);
            doc.text('Resumen:', 20, yPos);
            yPos += 10;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total de entregas: ${deliveries.length}`, 20, yPos);
            yPos += 8;
            doc.text(`Entregas completadas: ${deliveries.filter(d => d.status === 'completed').length}`, 20, yPos);
            yPos += 8;
            doc.text(`Distancia total recorrida: ${totalDistance.toFixed(2)} km`, 20, yPos);
            yPos += 8;
            doc.text(`Distancia promedio por entrega: ${(totalDistance / deliveries.length).toFixed(2)} km`, 20, yPos);

            yPos += 20;
            doc.setFontSize(14);
            doc.setTextColor(102, 126, 234);
            doc.text('Detalle de Entregas:', 20, yPos);
            yPos += 10;

            doc.setFontSize(10);
            deliveries.forEach((delivery, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setTextColor(0, 0, 0);
                doc.text(`${index + 1}. ${delivery.client}`, 20, yPos);
                yPos += 6;

                doc.setTextColor(100, 100, 100);
                doc.text(`   Inicio: ${formatTime(delivery.startTime)}`, 25, yPos);
                yPos += 5;

                if (delivery.endTime) {
                    doc.text(`   Fin: ${formatTime(delivery.endTime)}`, 25, yPos);
                    yPos += 5;
                    
                    const duration = Math.round((delivery.endTime - delivery.startTime) / (1000 * 60));
                    doc.text(`   Duraci√≥n: ${formatDuration(duration)}`, 25, yPos);
                    yPos += 5;
                }

                doc.text(`   Distancia: ${delivery.distance.toFixed(2)} km`, 25, yPos);
                yPos += 5;
                doc.text(`   Estado: ${delivery.status === 'completed' ? 'Completada' : 'En progreso'}`, 25, yPos);
                yPos += 10;
            });

            const today = new Date();
            const filename = `entregas_${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}.pdf`;
            
            doc.save(filename);
            showNotification('Reporte PDF generado exitosamente', 'success');
        }

        // Event listeners
        document.getElementById('clientName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDelivery();
            }
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        window.addEventListener('beforeunload', function(e) {
            if (isShiftActive && deliveries.length > 0) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de salir? Tienes una jornada activa.';
            }
        });
    </script>
</body>
</html>
